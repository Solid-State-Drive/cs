

## 컴퓨터 아키텍처와 운영체제

> 컴퓨터 아키텍처 : 컴퓨터의 여러 구성요초를 배치하는 방법
>
> 운영체제(OS, operating system) : 프로그램들의 실행을 제어하기 위한 감독 프로그램



### 기본적인 구조 요소들

- 컴퓨터 구조 - 폰 노이만 구조 / 하버드 구조
- 두 구조의 유일한 차이는 메모리 배열
  - 폰 노이만 구조는 동시에 명령어와 데이터를 가져올 수 없어서 하버드 구조보다 느리다.
- 프로세서 코어
  - 예전 CPU라고 부르던 것을 요즘은 프로세서 코어라 부른다.
  - 이런 코어가 여럿 들어가는 멀티코어 프로세서가 이제는 일반적으로 쓰인다.
- 마이크로프로세서와 마이크로 컴퓨터
  - 마이크로프로세서 : 메모리와 I/O가 프로세서 코어와 같은 패키지에 들어 있지 않는 프로세서
  - 마이크로 컴퓨터 : 모든 요소를 한 칩 안에 패키징



### 프로시저, 서브루틴, 함수

- 함수, 프로시저, 서브루틴는 코드를 재사용하는 주요 수단이다.
- 언어에 따라 이름만 다를 뿐 동일한 의미
- 함수를 호출하는 부분에서 함수를 실행하고 다시 원래 자리로 돌아올 방법이 필요
  - 이 과정은 상당히 많은 작업이 필요하며, 대부분의 기계는 이런 과정을 돕는 명령어를 제공한다.



### 스택

- 재귀(recursion)
  -  함수가 자기 자신을 호출
  - 재귀 함수가 제대로 작동하려면 반환 주소를 여럿 저장할 수 있어야 하며, 함수에서 호출 지점으로 반환할 때 저장된 주소 중 어떤 주소를 사용할지 결정할 수 있어야 한다.
- stack
  - LIFO 나중에 들어온 것이 먼저 나가는 구조
  - 스택 오버플로 : 스택에 물건을 푸시할 때, 더 이상 들어갈 공간이 없는 경우
  - 스택 언더플로 : 빈 스택에서 물건을 팝하는 경우
- 스택 프레임
  - 함수를 호출할 때 지역 변수도 스택에 저장하며, 각각의 함수 호출이 서로 독립적이게 된다.
  - 함수가 호출될 때마다 스택에 저장되는 데이터의 모음을 스택 프레임이라고 부른다.



### 인터럽트

- 인터럽트
  - 인터럽트 시스템은 적절한 신호가 들어오면 CPU 실행을 잠깐 중단시킬 수 있는 핀이나 전기 연결을 포함한다.
  - 대부분의 프로세서에는 인터럽트 시스템이 들어가 있다.
  - 장치 크기가 줄어듦에 따라 통합 주변장치가 들어 있고, 이런 장치들은 내부적으로 인터럽트 시스템에 연결되어 있다.
- 작동 방식
  - CPU가 주의를 기울여야 하는 주변장치는 인터럽트 요청을 생성
  - 프로세서는 현재 실행 중인 명령어를 끝까지 실행
  - 그 후 프로세서는 현재 실행 중인 프로그램을 잠시 중단시키고 인터럽트 핸들러(함수)라는 전혀 다른 프로글램을 실행
  - 인터럽트 핸들러가 필요한 작업을 다 마치면 원래 실행 중이던 프로그램이 중단된 위치부터 다시 실행

- 고려할 요소
  - 인터럽트에 대한 응답 시간 : 인터럽트 처리를 정해진 시간 안에 끝내야 한다.
  - 인터럽트를 서비스하고 나중에 다시 원래대로 돌아오기 위한 현재 상태를 저장할 방법이 필요하다.
    - 인터럽트 시스템은 서비스 후 돌아올 프로그램 위치를 스택에 저장
- 인터럽트 제어
  - 인터럽트 중단시킬 수 있는 마스크
  - 인터럽트 간의 우선순위에 따른 처리
  - 일정 시간이 지나면 인터럽틀르 발생시킬 수 있는 내장 타이머



### 상대 주소 지정

- 운영체제 or 운영체제 커널 : 각 프로그램을 서로 전환시켜 줄 수 있는 일종의 관리자 프로그램
- OS를 시스템 프로그램이라고 부르고 다른 모든 프로그램을 사용자 프로그램이나 프로세스라 부른다.
- OS는 타이머를 사용해 사용자 프로그램을 전환시켜줄지 판단하는데, 이러한 스케줄링 기법을 시분할이라 한다.
- 상대 주소 지정
  - 명령어에 들어 있는 주소를 0부터 시작하는 위치로 해석하지 않고, 명령어의 주소를 기준으로 하는 상대적인 주소로 해석



### 메모리 관리 장치

- 대부분의 마이크로프로세서에는 메모리 관리 장치(MMU)가 들어 있다.
  - MMU가 들어 있는 시스템은 가상 주소와 물리 주소를 구분한다.
  - MMU의 가상 주소 범위는 물리적 메모리 주소보다 큰 경우가 많다.



### 가상 메모리

- OS는 희소한 하드웨어 자원을 사용하려고 경합하는 프로그램들 사이의 자원 분배를 관리한다.
- 메모리도 OS가 관리하는 자원으로 OS는 MMU를 사용해 사용자 프로그램에게 가상 메모리를 제공한다.
- 요청받은 메모리가 사용가능한 메모리의 크기보다 클 경우
  - OS는 현재 필요하지 않은 메모리 페이지를 더 느리지만 더 용량이 큰 대용량 저장장치인 디스크로 옮긴다 - 스왑 아웃
  - 이런 스왑 아웃한 페이지에 프로그램이 접근하면 운영체제는 필요한 메모리 공간을 확보하고 요청받은 페이지를 다시 메모리로 불러들인다 - 스왑 인
  - 이러한 페이지 처리를 demand paging 이라고 한다.
- 스와핑이 일어나면 시스템 성능이 크게 저하된다.
- 성능 저하를 막기 위해 다양한 기법을 이용 ex) LRU



### 시스템 공간과  사용자 공간

- CPU에는 컴퓨터가 시스템 모드에 있는지 사용자 모드에 있는지 결정하는 비트가 어떤 레지스터 안에 들어 있다.
- I/O를 처리하는 명령어 등 일부 명령어는 특권 명령어라서 오직 시스템 모드에서만 실행할 수 있다.
- 트랩이나 시스템 콜이라고 부르는 특별한 명령어를 통해 사용자 모드에서 실행 중인 프로그램이 시스템 모드 프로그램에게 요청을 보낼 수 있다.
- 장점
  - 사용자 프로그램으로부터 운영체제를 보호하고, 사용자 프로그램을 다른 사용자 프로그램으로부터 보호
  - 사용자 프로그램이 MMU 등의 몇몇 요소에 손을 댈 수 없기 때문에 운영체제가 프로그램에 대한 자원 할당을 전적으로 제어할 수 있다.



### 메모리 계층과 성능

메모리 계층

빠르고 비쌈 <---------------------------------------------------------------->느리고 쌈

CPU - 레지스터 - L1캐시 - L2 캐시 - L3 캐시 - 주 메모리 - 대량 저장장치



### 코프로세서

- 프로세서 코어는 아주 복잡한 회로로 이루어져 있다.
- 몇 가지 연산을 코프로세서라는 더 단순한 회로에 위임하면 프로세서 코어가 일반적인 연산에 활용할 수 있는 공간을 더 확보할 수 있다.
- 일부 코프로세서는 다른 일은 처리하지 않고 데이터 복사만 담당하는데 이런 방식을 직접 메모리 접근이라 한다.



### 메모리상의 데이터 배치

- 메모리에 명령어만 담는게 아니라 데이터도 담을 수 있는데 이 경우 데이터는 정적 데이터다.
- 정적이라는 말은 얼마나 많은 메모리가 필요한지 알고 있다는 뜻
- 여러 데이터 영역을 서로 충돌하지 않게 배치할 수 있어야 한다.
- 동적 데이터는 프로그램을 실행하기 전에는 크기를 알 수 없는 데이터
  - 동적 데이터는 주로 정적 데이터가 차지하는 영역의 바로 위 영역에 쌓이며, 이를 힙이라 한다.
  - 더 많은 데이터를 저장해야 할 경우 스택은 아래로, 힙은 위로 늘어난다 - 충돌하지 않게 하는 것이 중요



### 프로그램 실행

- 라이브러리 : 관련 함수를 한데 모은 것
- 프로그램 전부를 한 파일에 저장할 수도 있지만, 이를 여러 파일로 나눠놓을 수도 있다
- 나누어 놓을 경우 여러 부분을 동시에 개발할 수 있다는 장점이 있지만 모든 조각을 하나로 엮거나 연결할 방법이 필요하다.
- 프로그램을 링크하기 편한 형식의 매개 파일로 나누고, 링커라는 특별한 프로그램을 사용해 여러 조각을 하나로 연결해 실행
- 실행과 링크가 가능한 형식은 현재 가장 유명한 매개 파일 형식
- 라이브러리를 프로그램의 나머지 부분과 직접 연결해 실행 파일을 만드는 방식을 정적 링크라 하며, 여러 프로그램에 쓰이기 때문에(여러 실행 파일에 반복적으로 들어가서 메모리 낭비를 막기위해) 공유 라이브러리를 사용하는 동적 링크를 만들었다.
- 진입점
  - 진입점은 프로그램의 첫 번째 명령어가 위치한 주소를 뜻한다.
  - 실제 프로그램이 실행될 때 가장 먼저 실행되는 명령어는 진입점에 있는 명령어가 아니다. 프로그램을 이루는 모든 부분이 하나로 합쳐져서 실행파일을 이룰 때 런타임 라이브러리가 추가된다. 이 런타임 라이브러리에 있는 명령어가 먼저 실행되고 나중에 진입점 명령어가 실행된다.



### 메모리 전력 소비

- 데이터를 메모리에서 옮기려면 전력이 소비된다.
- 전력 소비와 성능 사이의 균형을 잡는 것이 필요